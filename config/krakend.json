{
    "version": 2,
    "port": {{ .service.port }},
    "extra_config": {{ marshal .service.extra_config }},

    "endpoints": [
        {{ range .endpoints.endpoints }}
        {
            "endpoint": "{{ .endpoint }}",
            "headers_to_pass": ["sub", "customer_id", "country_code", "Content-Type", "Origin"],
            "method": "{{ .method }}",
            "output_encoding": "no-op",
            "querystring_params": {{ marshal .querystring_params }},
            "backend": [
                {
                    "host": [
                        "{{ .host }}"
                    ],
                    "url_pattern": "{{ .url_pattern }}",
                    "encoding": "no-op",
                    "extra_config": {
                        "github.com/devopsfaith/krakend-oauth2-clientcredentials": {
                            "client_id": "{{ $.auth.client_id }}",
                            "client_secret": "{{ $.auth.client_secret }}",
                            "token_url": "{{ $.auth.token_url }}",
                            "scopes": "{{ .internal_scope }}"
                        },
			"github.com/devopsfaith/krakend-lua/proxy/backend": {
                            "sources": [
                                "config/lua/jwt_claims.lua"
                            ],
                            "pre": "replace_path_with_jwt_claims3(request.load())",
                            "live": true,
                            "allow_open_libs": true
                        }
                    }
                }
            ],
            "extra_config": {
                "github.com/devopsfaith/krakend-jose/validator": {
                    "alg": "RS256",
                    "jwk-url": "{{ $.auth.jwk_url }}",
                    "roles_key": "scope",
                    "roles": {{ marshal .public_scopes }},
                    "propagate-claims": [
            ["sub", "sub"],
            ["customer_id", "customer_id"],
            ["country_code", "country_code"]
          ]
                }
            }
        },
        {{ end }}
        {{ marshal .healthcheck }}
    ]
}
